<%= form_with(model: actual_outfit, local: true, class: "space-y-8", id: "outfit-form") do |f| %>
  
  <%# --- ã‚¨ãƒ©ãƒ¼ãƒ¡ãƒƒã‚»ãƒ¼ã‚¸ --- %>
  <% if actual_outfit.errors.any? %>
    <div class="bg-red-50 text-red-700 p-4 rounded-xl border border-red-100 mb-6">
      <ul class="list-disc list-inside text-sm">
        <% actual_outfit.errors.full_messages.each do |message| %>
          <li><%= message %></li>
        <% end %>
      </ul>
    </div>
  <% end %>

  <%# ãƒ¡ã‚¤ãƒ³ãƒ•ã‚©ãƒ¼ãƒ ã‚¨ãƒªã‚¢ %>
  <div class="bg-white p-6 sm:p-8 rounded-3xl shadow-sm border border-stone-100">
    
    <%# --- 1. æ—¥ä»˜ã¨æ™‚é–“å¸¯ --- %>
    <div class="grid grid-cols-1 md:grid-cols-2 gap-8 mb-8">
      <div>
        <%= f.label :worn_on, "æ—¥ä»˜", class: "block text-sm font-bold text-stone-500 mb-2" %>
        <%= f.date_field :worn_on, class: "w-full bg-stone-50 border-stone-200 rounded-xl px-4 py-3 font-serif font-bold text-stone-700 focus:ring-indigo-500 focus:border-indigo-500" %>
      </div>

      <div>
        <label class="block text-sm font-bold text-stone-500 mb-2">æ™‚é–“å¸¯</label>
        <div class="grid grid-cols-2 gap-3">
          <% ActualOutfit.time_slots.keys.each do |key| %>
            <% 
              time_range = case key
                when 'morning'    then '06:00 - 11:59'
                when 'day'        then '12:00 - 17:59'
                when 'night'      then '18:00 - 23:59'
                when 'late_night' then '00:00 - 05:59'
              end
              style_classes = case key
                when 'morning'    then "peer-checked:bg-sky-50 peer-checked:border-sky-300 peer-checked:text-sky-700 text-stone-400"
                when 'day'        then "peer-checked:bg-blue-50 peer-checked:border-blue-300 peer-checked:text-blue-700 text-stone-400"
                when 'night'      then "peer-checked:bg-orange-50 peer-checked:border-orange-300 peer-checked:text-orange-700 text-stone-400"
                when 'late_night' then "peer-checked:bg-stone-100 peer-checked:border-stone-400 peer-checked:text-stone-700 text-stone-400"
              end
              icon_class = case key
                when 'morning'    then 'fa-sun'
                when 'day'        then 'fa-cloud-sun'
                when 'night'      then 'fa-moon'
                when 'late_night' then 'fa-star'
              end
            %>
            <label class="cursor-pointer group">
              <%= f.radio_button :time_slot, key, class: "peer sr-only" %>
              <div class="h-full py-3 px-2 rounded-xl border border-stone-200 bg-white hover:bg-stone-50 transition flex flex-col items-center justify-center gap-0.5 ring-2 ring-transparent peer-checked:ring-0 <%= style_classes %>">
                <i class="fas <%= icon_class %> text-xl mb-1"></i>
                <span class="text-xs font-bold"><%= I18n.t("enums.actual_outfit.time_slot.#{key}") %></span>
                <span class="text-[10px] opacity-70 font-feature-settings-tnum"><%= time_range %></span>
              </div>
            </label>
          <% end %>
        </div>
      </div>
    </div>

    <%# --- 2. ã‚¹ã‚±ã‚¸ãƒ¥ãƒ¼ãƒ«è©³ç´° --- %>
    <div class="mb-8 p-5 bg-stone-50 rounded-2xl border border-stone-100">
      <h3 class="text-sm font-bold text-stone-500 mb-4 flex items-center gap-2">
        <i class="fas fa-calendar-check text-indigo-400"></i> ã‚¹ã‚±ã‚¸ãƒ¥ãƒ¼ãƒ«æƒ…å ± (ä»»æ„)
      </h3>
      <div class="grid grid-cols-1 md:grid-cols-2 gap-6 mb-4">
        <div>
          <%= f.label :start_time, "é–‹å§‹æ™‚é–“", class: "block text-xs font-bold text-stone-400 mb-1" %>
          <%= f.time_field :start_time, class: "w-full bg-white border-stone-200 rounded-lg px-3 py-2 text-sm font-bold text-stone-700 focus:ring-indigo-500 focus:border-indigo-500" %>
        </div>
        <div>
          <%= f.label :title, "äºˆå®šå", class: "block text-xs font-bold text-stone-400 mb-1" %>
          <%= f.text_field :title, class: "w-full bg-white border-stone-200 rounded-lg px-3 py-2 text-sm font-bold text-stone-700 focus:ring-indigo-500 focus:border-indigo-500", placeholder: "ä¾‹ï¼šãƒ©ãƒ³ãƒã€ãƒ‡ãƒ¼ãƒˆ" %>
        </div>
      </div>
      <div>
        <label class="block text-xs font-bold text-stone-400 mb-2">ãƒ©ãƒ™ãƒ«ã®è‰²</label>
        <div class="flex flex-wrap gap-3 items-center">
          <% colors = ['#F87171', '#FB923C', '#FACC15', '#4ADE80', '#38BDF8', '#818CF8', '#C084FC', '#F472B6', '#A8A29E'] %>
          <% colors.each do |color| %>
            <label class="cursor-pointer group relative">
              <%= f.radio_button :color, color, class: "peer sr-only" %>
              <div class="w-8 h-8 rounded-full border-2 border-white shadow-sm transition transform hover:scale-110 peer-checked:scale-110 peer-checked:ring-2 peer-checked:ring-offset-2 peer-checked:ring-stone-400" style="background-color: <%= color %>;"></div>
            </label>
          <% end %>
          <label class="cursor-pointer group relative ml-2">
            <%= f.radio_button :color, "", class: "peer sr-only" %>
            <div class="w-8 h-8 rounded-full border border-stone-200 bg-white flex items-center justify-center text-stone-300 transition hover:bg-stone-50 peer-checked:ring-2 peer-checked:ring-offset-2 peer-checked:ring-stone-400">
              <i class="fas fa-ban text-xs"></i>
            </div>
          </label>
        </div>
      </div>
    </div>

    <%# --- 3. ã‚¢ã‚¤ãƒ†ãƒ é¸æŠ --- %>
    <div class="mb-8">
      <%= f.label :item_ids, "ç€ãŸ/ç€ã‚‹æœ (è¤‡æ•°é¸æŠå¯)", class: "block text-sm font-bold text-stone-500 mb-2" %>
      <div id="selected-items-container" class="grid grid-cols-3 sm:grid-cols-4 gap-3 mb-3">
        <div onclick="openItemModal()" class="cursor-pointer border-2 border-dashed border-stone-300 rounded-xl aspect-[3/4] flex flex-col items-center justify-center hover:bg-stone-50 hover:border-indigo-300 hover:text-indigo-500 text-stone-400 transition group" id="add-item-button">
          <i class="fas fa-plus text-xl mb-1 group-hover:scale-110 transition"></i>
          <span class="text-[10px] font-bold">è¿½åŠ </span>
        </div>
      </div>
      <div id="item-hidden-inputs"></div>
    </div>

    <%# --- 4. ä¼šã£ãŸäººé¸æŠ --- %>
    <div class="mb-8">
      <%= f.label :contact_ids, "ä¼šã£ãŸ/ä¼šã†äºº (è¤‡æ•°é¸æŠå¯)", class: "block text-sm font-bold text-stone-500 mb-2" %>
      <div id="selected-contacts-container" class="flex flex-wrap gap-2 mb-3">
        <div onclick="openContactModal()" class="cursor-pointer border border-dashed border-stone-300 rounded-full px-3 py-1.5 flex items-center gap-2 hover:bg-stone-50 hover:border-indigo-300 hover:text-indigo-500 text-stone-400 transition text-sm font-bold" id="add-contact-button">
          <i class="fas fa-plus"></i>
          <span>è¿½åŠ </span>
        </div>
      </div>
      <div id="contact-hidden-inputs"></div>
    </div>

    <%# --- 5. ãƒ¡ãƒ¢ --- %>
    <div class="mb-8">
      <%= f.label :memo, "ã²ã¨ã“ã¨ãƒ¡ãƒ¢", class: "block text-sm font-bold text-stone-500 mb-2" %>
      <%= f.text_area :memo, rows: 3, class: "w-full bg-stone-50 border-stone-200 rounded-xl px-4 py-3 text-stone-700 focus:ring-indigo-500 focus:border-indigo-500", placeholder: "æ¥½ã—ã‹ã£ãŸï¼å°‘ã—å¯’ã‹ã£ãŸã‹ã‚‚ã€‚" %>
    </div>
  </div>

  <%# --- ãƒ•ãƒƒã‚¿ãƒ¼ãƒœã‚¿ãƒ³ --- %>
  <div class="flex flex-col sm:flex-row gap-4 justify-center items-center pt-4 pb-20 sm:pb-0">
    <%= link_to "ã‚­ãƒ£ãƒ³ã‚»ãƒ«", :back, class: "w-full sm:w-auto text-center px-8 py-3 rounded-full text-stone-500 font-bold hover:bg-stone-100 transition" %>
    <%# type="button" ã«ã—ã¦JSã®handleRegisterClickã‚’ç™ºç«ã•ã›ã‚‹ %>
    <button type="button" onclick="handleRegisterClick()" class="w-full sm:w-auto px-10 py-3 rounded-full bg-indigo-600 text-white font-bold shadow-lg hover:bg-indigo-700 hover:shadow-xl transition transform hover:-translate-y-1 flex items-center justify-center gap-2">
      <i class="fas fa-check"></i>
      è¨˜éŒ²ã™ã‚‹
    </button>
  </div>
<% end %>


<%# ================================================================= %>
<%#  ã€ãƒ¢ãƒ¼ãƒ€ãƒ«: é‡è¤‡è­¦å‘Šãƒãƒƒãƒ—ã‚¢ãƒƒãƒ—ã€‘ (çµµæ–‡å­—ã®ã‚¯ãƒ­ãƒ¼ãƒãƒ¼ç‰ˆ)          %>
<%# ================================================================= %>
<div id="duplicate-warning-modal" class="fixed inset-0 z-[200] flex items-center justify-center hidden">
  <%# èƒŒæ™¯: æ¸©ã‹ã¿ã®ã‚ã‚‹ã‚ªãƒ¬ãƒ³ã‚¸ç³»ã®ã¼ã‹ã— %>
  <div class="absolute inset-0 bg-orange-100/60 backdrop-blur-sm transition-opacity"></div>
  
  <%# ãƒ‘ãƒãƒ«æœ¬ä½“: æ·¡ã„ã‚ªãƒ¬ãƒ³ã‚¸èƒŒæ™¯ã€ä¸¸ã¿ã®ã‚ã‚‹ãƒ‡ã‚¶ã‚¤ãƒ³ %>
  <div class="relative w-[90%] max-w-[400px] bg-orange-50 rounded-3xl shadow-xl overflow-hidden transform transition-all p-6 border border-orange-100">
    
    <div class="text-center mb-6">
      <%# ã‚¢ã‚¤ã‚³ãƒ³ã‚¨ãƒªã‚¢: æ·¡ã„ã‚ªãƒ¬ãƒ³ã‚¸ã®ä¸¸èƒŒæ™¯ã«ã€çµµæ–‡å­—ã®ã‚¯ãƒ­ãƒ¼ãƒãƒ¼ğŸ€ %>
      <div class="inline-flex items-center justify-center w-16 h-16 rounded-full bg-orange-100 mb-4 shadow-sm">
        <span class="text-3xl">ğŸ€</span>
      </div>
      <%# ã‚¿ã‚¤ãƒˆãƒ«: è¦ªã—ã¿ã‚„ã™ã„å¤ªå­—ãƒ•ã‚©ãƒ³ãƒˆ %>
      <h3 class="text-xl font-bold text-gray-800 font-serif mb-2 tracking-wide">
        ã‚³ãƒ¼ãƒ‡ã‚£ãƒãƒ¼ãƒˆã®ãƒ’ãƒ³ãƒˆ
      </h3>
      <%# æœ¬æ–‡: æŸ”ã‚‰ã‹ã„è¡¨ç¾ %>
      <p class="text-sm text-gray-600 leading-relaxed">
        ç›´è¿‘3ãƒ¶æœˆä»¥å†…ã«ã€åŒã˜ãŠç›¸æ‰‹ã«ã“ã®ã‚¢ã‚¤ãƒ†ãƒ ã‚’ç€ç”¨ã—ã¦ä¼šã£ã¦ã„ã‚‹ã‚ˆã†ã§ã™ã€‚
      </p>
    </div>

    <%# ãƒªã‚¹ãƒˆè¡¨ç¤ºã‚¨ãƒªã‚¢ï¼ˆãƒ‡ã‚¶ã‚¤ãƒ³èª¿æ•´æ¸ˆã¿ï¼‰ %>
    <div class="bg-white/80 rounded-xl p-4 mb-6 max-h-48 overflow-y-auto custom-scrollbar border border-orange-100 shadow-inner" id="duplicate-list-content">
      <%# ã“ã“ã«JSã§ãƒªã‚¹ãƒˆã‚’æ³¨å…¥ %>
    </div>

    <div class="flex flex-col gap-3">
      <%# ãƒœã‚¿ãƒ³: ã‚ªãƒ¬ãƒ³ã‚¸ç³»ã®æ ç·šã§æ¸©ã‹ã¿ã‚’è¡¨ç¾ %>
      <button type="button" onclick="closeDuplicateModal()" class="w-full py-3 rounded-full bg-white border-2 border-orange-300 text-orange-600 font-bold hover:bg-orange-50 transition duration-200 shadow-sm">
        åˆ¥ã®ã‚¢ã‚¤ãƒ†ãƒ ã‚’æ¤œè¨ã™ã‚‹
      </button>
      <%# ãƒœã‚¿ãƒ³: ã‚¢ã‚¯ã‚·ãƒ§ãƒ³ã‚’ä¿ƒã™é’ç³» %>
      <button type="button" onclick="submitFormForce()" class="w-full py-3 rounded-full bg-indigo-600 text-white font-bold shadow-md hover:bg-indigo-700 transition duration-200">
        ã“ã®ã¾ã¾ç™»éŒ²ã™ã‚‹
      </button>
    </div>
  </div>
</div>


<%# ================================================================= %>
<%#  ã€ãƒ¢ãƒ¼ãƒ€ãƒ«ã€‘ (ã‚¢ã‚¤ãƒ†ãƒ  & ã‚³ãƒ³ã‚¿ã‚¯ãƒˆ) current_user!!!               %>
<%# ================================================================= %>

<%# ã‚¢ã‚¤ãƒ†ãƒ ãƒ¢ãƒ¼ãƒ€ãƒ« %>
<div id="item-modal" class="fixed inset-0 z-[100] hidden">
  <div class="absolute inset-0 bg-stone-900/60 backdrop-blur-sm" onclick="closeItemModal()"></div>
  <div class="absolute inset-x-0 bottom-0 top-10 sm:inset-x-10 sm:bottom-10 bg-[#FDFBF7] rounded-t-2xl sm:rounded-2xl shadow-2xl overflow-hidden flex flex-col">
    <div class="p-4 border-b border-stone-100 flex justify-between items-center bg-white z-10 shadow-sm shrink-0">
      <h3 class="font-bold text-lg text-stone-700 font-serif">ã‚¢ã‚¤ãƒ†ãƒ ã‚’é¸ã¶</h3>
      <button type="button" onclick="closeItemModal()" class="w-8 h-8 rounded-full bg-stone-100 hover:bg-stone-200 flex items-center justify-center transition">
        <i class="fas fa-times"></i>
      </button>
    </div>
    <div class="flex-1 overflow-y-auto p-4 custom-scrollbar">
      <div class="grid grid-cols-2 sm:grid-cols-3 md:grid-cols-5 gap-3">
        <%# â˜…è‡ªåˆ†(current_user)ã®ã‚¢ã‚¤ãƒ†ãƒ ã®ã¿ã‚’è¡¨ç¤º !!!%>
        <% current_user.items.includes(image_attachment: :blob).order(created_at: :desc).each do |item| %>
          <div onclick="toggleItemSelection(this, '<%= item.id %>', '<%= j item.name %>', '<%= item.image.attached? ? url_for(item.image.variant(resize_to_limit: [300, 300])) : "" %>')" data-id="<%= item.id %>" class="item-option relative group rounded-xl overflow-hidden aspect-[3/4] cursor-pointer border-2 border-transparent transition active:scale-95">
            <div class="w-full h-full bg-white relative">
              <% if item.image.attached? %>
                <%= image_tag item.image.variant(resize_to_limit: [300, 300]), class: "w-full h-full object-cover", loading: "lazy" %>
              <% else %>
                <div class="w-full h-full flex items-center justify-center bg-stone-50 text-stone-300"><i class="fas fa-tshirt text-2xl"></i></div>
              <% end %>
              <div class="absolute inset-0 bg-indigo-900/20 hidden check-overlay"></div>
            </div>
            <div class="absolute top-2 right-2 w-6 h-6 rounded-full bg-indigo-600 text-white flex items-center justify-center shadow-md transform scale-0 transition check-mark"><i class="fas fa-check text-xs"></i></div>
            <div class="absolute bottom-0 inset-x-0 bg-white/90 p-1.5 text-center"><p class="text-[10px] font-bold text-stone-700 truncate"><%= item.name %></p></div>
          </div>
        <% end %>
      </div>
    </div>
    <div class="p-4 border-t border-stone-100 bg-white shrink-0 flex justify-end">
      <button type="button" onclick="confirmItemSelection()" class="bg-indigo-600 text-white text-sm font-bold px-8 py-3 rounded-full hover:bg-indigo-700 transition shadow-md hover:shadow-lg transform active:scale-95">æ±ºå®šã™ã‚‹</button>
    </div>
  </div>
</div>

<%# ã‚³ãƒ³ã‚¿ã‚¯ãƒˆãƒ¢ãƒ¼ãƒ€ãƒ« %>
<div id="contact-modal" class="fixed inset-0 z-[100] hidden">
  <div class="absolute inset-0 bg-stone-900/60 backdrop-blur-sm" onclick="closeContactModal()"></div>
  <div class="absolute inset-x-0 bottom-0 top-1/3 sm:inset-x-auto sm:left-1/2 sm:top-1/2 sm:-translate-x-1/2 sm:-translate-y-1/2 sm:w-96 sm:h-auto bg-[#FDFBF7] rounded-t-2xl sm:rounded-2xl shadow-2xl overflow-hidden flex flex-col">
    <div class="p-4 border-b border-stone-100 flex justify-between items-center bg-white shadow-sm shrink-0">
      <h3 class="font-bold text-lg text-stone-700 font-serif">ä¼šã£ãŸäººã‚’é¸ã¶</h3>
      <button type="button" onclick="closeContactModal()" class="w-8 h-8 rounded-full bg-stone-100 hover:bg-stone-200 flex items-center justify-center transition">
        <i class="fas fa-times"></i>
      </button>
    </div>
    <div class="flex-1 overflow-y-auto p-4 custom-scrollbar">
      <%# â˜…è‡ªåˆ†(current_user)ã®ã‚³ãƒ³ã‚¿ã‚¯ãƒˆã®ã¿è¡¨ç¤º %>
      <% current_user.contacts.includes(avatar_attachment: :blob).order(:name).each do |contact| %>
        <div onclick="toggleContactSelection(this, '<%= contact.id %>', '<%= j contact.name %>', '<%= contact.avatar.attached? ? url_for(contact.avatar.variant(resize_to_limit: [100, 100])) : "" %>')" data-id="<%= contact.id %>" class="contact-option flex items-center gap-3 p-3 bg-white rounded-xl border-2 border-transparent mb-2 cursor-pointer hover:bg-stone-50 transition active:scale-95">
          <div class="w-10 h-10 rounded-full bg-stone-100 overflow-hidden border border-stone-200 flex-shrink-0 relative">
             <% if contact.avatar.attached? %>
               <%= image_tag contact.avatar.variant(resize_to_limit: [100, 100]), class: "w-full h-full object-cover", loading: "lazy" %>
             <% else %>
               <div class="w-full h-full flex items-center justify-center text-stone-400 text-xs font-bold"><%= contact.name.first %></div>
             <% end %>
             <div class="absolute inset-0 bg-indigo-600/30 hidden check-overlay"></div>
          </div>
          <span class="font-bold text-stone-700 flex-1"><%= contact.name %></span>
          <div class="w-6 h-6 rounded-full bg-indigo-600 text-white flex items-center justify-center shadow-sm transform scale-0 transition check-mark"><i class="fas fa-check text-xs"></i></div>
        </div>
      <% end %>
    </div>
    <div class="p-4 border-t border-stone-100 bg-white shrink-0 flex justify-end">
      <button type="button" onclick="confirmContactSelection()" class="bg-indigo-600 text-white text-sm font-bold px-8 py-3 rounded-full hover:bg-indigo-700 transition shadow-md hover:shadow-lg transform active:scale-95">æ±ºå®šã™ã‚‹</button>
    </div>
  </div>
</div>

<script>
  let selectedItemIds = new Set();
  let selectedItemData = new Map();
  let selectedContactIds = new Set();
  let selectedContactData = new Map();
  const currentRecordId = "<%= actual_outfit.id %>"; 

  // --- åˆæœŸåŒ– ---
  <% actual_outfit.items.each do |item| %>
    selectedItemIds.add('<%= item.id %>');
    selectedItemData.set('<%= item.id %>', { name: '<%= j item.name %>', imageUrl: '<%= item.image.attached? ? url_for(item.image.variant(resize_to_limit: [300, 300])) : "" %>' });
  <% end %>

  <% actual_outfit.contacts.each do |contact| %>
    selectedContactIds.add('<%= contact.id %>');
    selectedContactData.set('<%= contact.id %>', { name: '<%= j contact.name %>', avatarUrl: '<%= contact.avatar.attached? ? url_for(contact.avatar.variant(resize_to_limit: [100, 100])) : "" %>' });
  <% end %>

  function initForms() {
    renderSelectedItems();
    generateHiddenInputs('item');
    renderSelectedContacts();
    generateHiddenInputs('contact');
  }

  document.addEventListener("turbo:load", initForms);
  document.addEventListener("DOMContentLoaded", initForms);

  function generateHiddenInputs(type) {
    const container = document.getElementById(`${type}-hidden-inputs`);
    if(!container) return;
    container.innerHTML = '';
    const ids = (type === 'item') ? selectedItemIds : selectedContactIds;
    const paramName = (type === 'item') ? 'actual_outfit[item_ids][]' : 'actual_outfit[contact_ids][]';
    ids.forEach(id => {
      const input = document.createElement('input');
      input.type = 'hidden';
      input.name = paramName;
      input.value = id;
      container.appendChild(input);
    });
  }

  // --- â˜…æ–°æ©Ÿèƒ½: ç™»éŒ²ãƒœã‚¿ãƒ³ã‚¯ãƒªãƒƒã‚¯æ™‚ã®å‡¦ç† (ãƒãƒƒãƒ—ã‚¢ãƒƒãƒ—åˆ¶å¾¡) ---
  async function handleRegisterClick() {
    if (selectedItemIds.size === 0 || selectedContactIds.size === 0) {
      submitFormForce(); // ã‚¢ã‚¤ãƒ†ãƒ ã‹äººãŒãªã‘ã‚Œã°ãã®ã¾ã¾é€ä¿¡
      return;
    }

    const params = new URLSearchParams();
    selectedItemIds.forEach(id => params.append('item_ids[]', id));
    selectedContactIds.forEach(id => params.append('contact_ids[]', id));
    if(currentRecordId) params.append('id', currentRecordId);

    try {
      const response = await fetch(`/actual_outfits/check_duplicates?${params.toString()}`, {
        headers: { "Accept": "application/json" }
      });
      const data = await response.json();

      if (data.duplicates && data.duplicates.length > 0) {
        // é‡è¤‡ãŒã‚ã‚Œã°ãƒãƒƒãƒ—ã‚¢ãƒƒãƒ—ã‚’è¡¨ç¤º
        showDuplicateModal(data.duplicates);
      } else {
        // é‡è¤‡ãŒãªã‘ã‚Œã°ãã®ã¾ã¾é€ä¿¡
        submitFormForce();
      }
    } catch (error) {
      console.error("Duplicate check failed:", error);
      submitFormForce(); // ã‚¨ãƒ©ãƒ¼æ™‚ã¯æ­¢ã¾ã‚‰ãšé€ä¿¡
    }
  }

  function showDuplicateModal(duplicates) {
    const listArea = document.getElementById('duplicate-list-content');
    listArea.innerHTML = '';
    
    duplicates.forEach(dup => {
      const div = document.createElement('div');
      // æ—¥ä»˜ã¨å†…å®¹ã‚’è¦‹ã‚„ã™ãæ•´å½¢ (ã‚ªãƒ¬ãƒ³ã‚¸ç³»ã®ãƒœãƒ¼ãƒ€ãƒ¼)
      div.className = "flex items-start gap-3 mb-3 pb-3 border-b border-orange-100 last:border-0 last:mb-0 last:pb-0";
      
      div.innerHTML = `
        <div class="text-xs text-stone-500 font-bold whitespace-nowrap pt-1">${dup.date}</div>
        <div class="text-sm text-stone-700 leading-snug">
          <span class="font-bold text-stone-800">${dup.overlapping_contacts.join(', ')}</span> ã•ã‚“ã¨ä¼šã£ãŸæ™‚ã«
          <span class="font-bold text-orange-500">${dup.overlapping_items.join(', ')}</span> ã‚’ç€ã¦ã„ã¾ã—ãŸ
        </div>
      `;
      listArea.appendChild(div);
    });

    document.getElementById('duplicate-warning-modal').classList.remove('hidden');
    document.getElementById('duplicate-warning-modal').classList.add('flex');
  }

  function closeDuplicateModal() {
    const modal = document.getElementById('duplicate-warning-modal');
    modal.classList.add('hidden');
    modal.classList.remove('flex');
  }

  function submitFormForce() {
    document.getElementById('outfit-form').submit();
  }

  // --- ã‚¢ã‚¤ãƒ†ãƒ æç”» ---
  function renderSelectedItems() {
    const container = document.getElementById('selected-items-container');
    const btn = document.getElementById('add-item-button');
    while (container.firstChild && container.firstChild !== btn) container.removeChild(container.firstChild);

    selectedItemData.forEach((data, id) => {
      const div = document.createElement('div');
      div.className = "relative group rounded-xl overflow-hidden aspect-[3/4] border border-stone-200 bg-white shadow-sm";
      const imgHtml = data.imageUrl 
        ? `<img src="${data.imageUrl}" class="w-full h-full object-cover">` 
        : `<div class="w-full h-full flex items-center justify-center bg-stone-50 text-stone-300"><i class="fas fa-tshirt text-2xl"></i></div>`;

      div.innerHTML = `
        ${imgHtml}
        <div class="absolute inset-0 bg-black/5 pointer-events-none"></div>
        <div class="absolute bottom-0 inset-x-0 bg-white/90 p-1 text-[9px] font-bold text-center truncate text-stone-700">${data.name}</div>
        <div onclick="removeItem('${id}')" class="absolute top-1 right-1 w-7 h-7 bg-white rounded-full flex items-center justify-center shadow-md cursor-pointer text-stone-500 hover:text-red-500 hover:bg-stone-50 transition z-20">
          <svg xmlns="http://www.w3.org/2000/svg" viewBox="0 0 24 24" fill="currentColor" class="w-5 h-5"><path fill-rule="evenodd" d="M5.47 5.47a.75.75 0 011.06 0L12 10.94l5.47-5.47a.75.75 0 111.06 1.06L13.06 12l5.47 5.47a.75.75 0 11-1.06 1.06L12 13.06l-5.47 5.47a.75.75 0 01-1.06-1.06L10.94 12 5.47 6.53a.75.75 0 010-1.06z" clip-rule="evenodd" /></svg>
        </div>
      `;
      container.insertBefore(div, btn);
    });
  }
  function removeItem(id) { selectedItemIds.delete(id); selectedItemData.delete(id); renderSelectedItems(); generateHiddenInputs('item'); }

  // --- äººæç”» ---
  function renderSelectedContacts() {
    const container = document.getElementById('selected-contacts-container');
    const btn = document.getElementById('add-contact-button');
    while (container.firstChild && container.firstChild !== btn) container.removeChild(container.firstChild);

    selectedContactData.forEach((data, id) => {
      const div = document.createElement('div');
      div.className = "flex items-center gap-2 pl-1 pr-2 py-1 bg-white border border-stone-200 rounded-full shadow-sm select-none";
      const imgTag = data.avatarUrl 
        ? `<img src="${data.avatarUrl}" class="w-full h-full object-cover">` 
        : `<div class="w-full h-full flex items-center justify-center text-[8px] text-stone-500 font-bold">${data.name.charAt(0)}</div>`;
      
      div.innerHTML = `
        <div class="w-6 h-6 rounded-full bg-stone-100 overflow-hidden relative border border-stone-200">${imgTag}</div>
        <span class="text-xs font-bold text-stone-600">${data.name}</span>
        <div onclick="removeContact('${id}')" class="w-6 h-6 flex items-center justify-center text-stone-400 hover:text-red-500 cursor-pointer ml-1 rounded-full hover:bg-stone-50 transition">
          <svg xmlns="http://www.w3.org/2000/svg" viewBox="0 0 24 24" fill="currentColor" class="w-4 h-4"><path fill-rule="evenodd" d="M5.47 5.47a.75.75 0 011.06 0L12 10.94l5.47-5.47a.75.75 0 111.06 1.06L13.06 12l5.47 5.47a.75.75 0 11-1.06 1.06L12 13.06l-5.47 5.47a.75.75 0 01-1.06-1.06L10.94 12 5.47 6.53a.75.75 0 010-1.06z" clip-rule="evenodd" /></svg>
        </div>
      `;
      container.insertBefore(div, btn);
    });
  }
  function removeContact(id) { selectedContactIds.delete(id); selectedContactData.delete(id); renderSelectedContacts(); generateHiddenInputs('contact'); }

  // --- ãƒ¢ãƒ¼ãƒ€ãƒ«æ“ä½œç³» (å¤‰æ›´ãªã—) ---
  function openItemModal() { document.getElementById('item-modal').classList.remove('hidden'); document.querySelectorAll('.item-option').forEach(el => updateVisualState(el, selectedItemIds.has(el.dataset.id))); }
  function closeItemModal() { document.getElementById('item-modal').classList.add('hidden'); }
  function toggleItemSelection(el, id, name, imageUrl) {
    if (selectedItemIds.has(id)) { selectedItemIds.delete(id); selectedItemData.delete(id); updateVisualState(el, false); } 
    else { selectedItemIds.add(id); selectedItemData.set(id, {name, imageUrl}); updateVisualState(el, true); }
  }
  function updateVisualState(el, isSelected) {
    const overlay = el.querySelector('.check-overlay'), mark = el.querySelector('.check-mark');
    if (isSelected) { el.classList.add('ring-2', 'ring-indigo-600', 'ring-offset-1'); overlay.classList.remove('hidden'); mark.classList.remove('scale-0'); }
    else { el.classList.remove('ring-2', 'ring-indigo-600', 'ring-offset-1'); overlay.classList.add('hidden'); mark.classList.add('scale-0'); }
  }
  function confirmItemSelection() { renderSelectedItems(); generateHiddenInputs('item'); closeItemModal(); }

  function openContactModal() { document.getElementById('contact-modal').classList.remove('hidden'); document.querySelectorAll('.contact-option').forEach(el => updateContactVisualState(el, selectedContactIds.has(el.dataset.id))); }
  function closeContactModal() { document.getElementById('contact-modal').classList.add('hidden'); }
  function toggleContactSelection(el, id, name, avatarUrl) {
    if (selectedContactIds.has(id)) { selectedContactIds.delete(id); selectedContactData.delete(id); updateContactVisualState(el, false); }
    else { selectedContactIds.add(id); selectedContactData.set(id, {name, avatarUrl}); updateContactVisualState(el, true); }
  }
  function updateContactVisualState(el, isSelected) {
    const mark = el.querySelector('.check-mark');
    if (isSelected) { el.classList.add('border-indigo-600', 'bg-indigo-50'); mark.classList.remove('scale-0'); }
    else { el.classList.remove('border-indigo-600', 'bg-indigo-50'); mark.classList.add('scale-0'); }
  }
  function confirmContactSelection() { renderSelectedContacts(); generateHiddenInputs('contact'); closeContactModal(); }
</script>