<div class="max-w-7xl mx-auto px-2 sm:px-4 py-4 sm:py-6">

  <%# --- „ÇØ„É≠„Éº„Çº„ÉÉ„Éà„Å´Êàª„Çã„Éú„Çø„É≥ --- %>
  <div class="mb-4">
    <%= link_to root_path, class: "inline-flex items-center gap-2 text-sm font-bold text-stone-400 hover:text-indigo-600 transition group" do %>
      <span class="w-8 h-8 rounded-full bg-white border border-stone-200 flex items-center justify-center group-hover:border-indigo-300 group-hover:bg-indigo-50 transition">
        <i class="fas fa-arrow-left text-xs"></i>
      </span>
      <span>„ÇØ„É≠„Éº„Çº„ÉÉ„Éà„Å∏Êàª„Çã</span>
    <% end %>
  </div>

  <%# --- „Éò„ÉÉ„ÉÄ„ÉºÔºöÈÄ±ÁßªÂãï„Éä„Éì„Ç≤„Éº„Ç∑„Éß„É≥ --- %>
  <div class="flex items-center justify-between mb-4 sm:mb-6 bg-white p-3 rounded-xl shadow-sm border border-stone-100 relative">
    <%= link_to calendar_path(start_date: @start_date - 1.week), class: "w-10 h-10 flex items-center justify-center rounded-full hover:bg-stone-100 text-stone-400 hover:text-indigo-600 transition" do %>
      <i class="fas fa-chevron-left"></i>
    <% end %>

    <div class="text-center flex flex-col items-center">
      <h1 class="text-lg sm:text-2xl font-bold text-stone-700 tracking-wider font-serif">
        <%= @start_date.strftime("%YÂπ¥ %-mÊúà") %>
      </h1>
      <div class="flex items-center gap-2 mt-1">
        <p class="text-xs text-stone-400 font-bold">
          <%= @start_date.strftime("%-dÊó•") %> „Äú <%= @end_date.strftime("%-dÊó•") %>
        </p>
        <% unless Date.current.all_week.include?(@start_date) %>
          <%= link_to "‰ªäÊó•", calendar_path, class: "text-[10px] bg-indigo-50 text-indigo-600 px-2 py-0.5 rounded-full font-bold hover:bg-indigo-100 transition" %>
        <% end %>
      </div>
    </div>

    <%= link_to calendar_path(start_date: @start_date + 1.week), class: "w-10 h-10 flex items-center justify-center rounded-full hover:bg-stone-100 text-stone-400 hover:text-indigo-600 transition" do %>
      <i class="fas fa-chevron-right"></i>
    <% end %>
  </div>

  <%# ================================================================= %>
  <%#  „ÄêPCÁî®Ë°®Á§∫„Äë (md‰ª•‰∏ä„ÅßË°®Á§∫)                                      %>
  <%# ================================================================= %>
  <div class="hidden md:grid grid-cols-7 gap-px bg-stone-100 border border-stone-100 rounded-lg overflow-hidden shadow-sm">
    <% @week_days.each do |date| %>
      <div class="bg-white p-2 text-center">
        <span class="block text-xs font-bold text-stone-400 uppercase tracking-widest <%= 'text-red-400' if date.sunday? %> <%= 'text-blue-400' if date.saturday? %>">
          <%= %w(SUN MON TUE WED THU FRI SAT)[date.wday] %>
        </span>
        <span class="block text-xl font-bold font-serif text-stone-700 <%= 'bg-indigo-600 text-white rounded-full w-8 h-8 flex items-center justify-center mx-auto mt-1' if date == Date.current %>">
          <%= date.day %>
        </span>
      </div>
    <% end %>

    <% ActualOutfit.time_slots.keys.each do |slot_key| %>
      <% 
        style_config = case slot_key
          when 'morning'    then { bg: 'bg-gradient-to-b from-[#F0F9FF] to-[#E0F2FE]', icon: 'fa-sun', icon_color: 'text-sky-200', label: 'Êúù', time: '06:00 - 11:59' }
          when 'day'        then { bg: 'bg-gradient-to-b from-[#E0F2FE] to-[#BAE6FD]', icon: 'fa-cloud-sun', icon_color: 'text-blue-200', label: 'Êòº', time: '12:00 - 17:59' }
          when 'night'      then { bg: 'bg-gradient-to-b from-[#FFF7ED] to-[#FFEDD5]', icon: 'fa-moon', icon_color: 'text-orange-200', label: 'Â§ïÊñπ', time: '18:00 - 23:59' }
          when 'late_night' then { bg: 'bg-gradient-to-b from-[#FAFAF9] to-[#E7E5E4]', icon: 'fa-star', icon_color: 'text-stone-300', label: 'Â§ú', time: '00:00 - 05:59' }
        end
      %>

      <% @week_days.each do |date| %>
        <% outfits = @outfits_map[[date, slot_key]] || [] %>
        <div class="relative h-48 group hover:shadow-lg transition duration-300 <%= style_config[:bg] %> flex flex-col p-1 overflow-hidden">
          <div class="absolute top-2 left-2 text-4xl <%= style_config[:icon_color] %> pointer-events-none opacity-40 transform group-hover:scale-110 transition duration-500">
            <i class="fas <%= style_config[:icon] %>"></i>
          </div>
          <div class="absolute top-1 right-2 text-right pointer-events-none z-0">
            <div class="text-xs font-bold text-stone-500/90"><%= style_config[:label] %></div>
            <div class="text-[9px] font-bold text-stone-400/70 tracking-tighter"><%= style_config[:time] %></div>
          </div>

          <div class="relative z-10 flex flex-col gap-1.5 w-full h-full overflow-y-auto custom-scrollbar pt-8 pb-2 px-0.5">
            <% outfits.each do |outfit| %>
              <%= link_to actual_outfit_path(outfit), class: "block w-full flex-shrink-0 relative group/item" do %>
                <% if outfit.title.present? %>
                  <div class="w-full rounded shadow-sm px-2 py-1 text-white transition transform hover:-translate-y-0.5 hover:shadow-md relative" style="background-color: <%= outfit.color.presence || '#A8A29E' %>;">
                    <div class="flex items-center gap-1 mb-0.5">
                      <% if outfit.start_time %>
                        <span class="text-[9px] font-bold opacity-90 font-feature-settings-tnum bg-black/10 px-1 rounded-sm leading-none"><%= outfit.start_time.strftime("%H:%M") %></span>
                      <% end %>
                      <div class="text-xs font-bold truncate leading-tight flex-1"><%= outfit.title %></div>
                    </div>
                  </div>
                <% else %>
                  <div class="w-full bg-white/80 backdrop-blur-[2px] rounded border border-white/50 shadow-sm px-2 py-1 flex items-center gap-2 hover:bg-white transition transform hover:-translate-y-0.5 relative">
                    <span class="text-lg leading-none">üëò</span>
                    <% if outfit.start_time %>
                      <span class="text-[10px] font-bold text-stone-500 font-feature-settings-tnum"><%= outfit.start_time.strftime("%H:%M") %></span>
                    <% end %>
                  </div>
                <% end %>
                <% if outfit.items.size > 0 %>
                  <div class="absolute -top-1.5 -right-1 w-4 h-4 rounded-full bg-red-500 border border-white flex items-center justify-center shadow-md z-20">
                    <span class="text-[9px] font-bold text-white font-sans leading-none"><%= outfit.items.size %></span>
                  </div>
                <% end %>
              <% end %>
            <% end %>
            <%= link_to new_actual_outfit_path(worn_on: date, time_slot: slot_key), class: "flex-grow min-h-[20px] rounded hover:bg-black/5 transition flex items-center justify-center group/add -mx-1" do %>
               <i class="fas fa-plus text-stone-400 opacity-0 group-hover/add:opacity-100 transition"></i>
            <% end %>
          </div>
        </div>
      <% end %>
    <% end %>
  </div>


  <%# ================================================================= %>
  <%#  „Äê„Çπ„Éû„ÉõÁî®Ë°®Á§∫„Äë „É™„Çπ„Éà + „Éú„Çø„É≥ÂΩ¢Âºè                %>
  <%# ================================================================= %>
  <div class="md:hidden space-y-3">
    <% @week_days.each do |date| %>
      <% is_today = (date == Date.current) %>
      <% 
         # „Åù„ÅÆÊó•„ÅÆÂÖ®‰∫àÂÆö„ÇíÂèñÂæó (ÊôÇÈñìÂ∏ØÂïè„Çè„Åö)
         day_outfits = @outfits.select { |o| o.worn_on == date }
         has_plan = day_outfits.any?
      %>
      
      <%# „É™„Çπ„Éà„Ç¢„Ç§„ÉÜ„É† %>
      <div class="bg-white rounded-2xl p-4 shadow-sm border border-stone-100 relative overflow-hidden flex items-center justify-between">
        
        <% if is_today %>
          <div class="absolute left-0 top-0 bottom-0 w-1.5 bg-indigo-500"></div>
        <% end %>

        <%# --- Â∑¶ÂÅ¥: Êó•‰ªò„Å®„Éâ„ÉÉ„Éà --- %>
        <div class="flex items-center gap-4">
           <div class="text-center w-10">
              <div class="text-[10px] font-bold text-stone-400 uppercase tracking-wider <%= 'text-red-400' if date.sunday? %> <%= 'text-blue-400' if date.saturday? %>">
                <%= %w(Êó• Êúà ÁÅ´ Ê∞¥ Êú® Èáë Âúü)[date.wday] %>
              </div>
              <div class="text-xl font-bold font-serif text-stone-700 <%= 'text-indigo-600' if is_today %>">
                <%= date.day %>
              </div>
           </div>
           
           <%# „Éâ„ÉÉ„ÉàË°®Á§∫ %>
           <div class="flex gap-1.5">
             <% ActualOutfit.time_slots.keys.each do |slot| %>
               <% if @outfits_map[[date, slot]].present? %>
                 <div class="w-2.5 h-2.5 rounded-full ring-1 ring-white shadow-sm
                   <%= case slot 
                       when 'morning' then 'bg-sky-200'
                       when 'day' then 'bg-blue-400'
                       when 'night' then 'bg-orange-300'
                       when 'late_night' then 'bg-stone-400'
                       end %>"></div>
               <% else %>
                 <div class="w-2 h-2 rounded-full bg-stone-100"></div>
               <% end %>
             <% end %>
           </div>
        </div>

        <%# --- Âè≥ÂÅ¥: „Éú„Çø„É≥Áæ§ --- %>
        <div class="flex items-center gap-2">
          <%# Ë©≥Á¥∞„Éú„Çø„É≥ %>
          <% if has_plan %>
            <button onclick="openDayDetail('<%= date %>')" class="px-3 py-2 rounded-xl bg-indigo-50 text-indigo-600 font-bold text-xs flex items-center gap-1.5 hover:bg-indigo-100 transition active:scale-95 border border-indigo-100 shadow-sm">
              <i class="fas fa-list"></i>
              Ë©≥Á¥∞
            </button>
          <% else %>
            <button onclick="alert('‰∫àÂÆö„Åå„ÅÇ„Çä„Åæ„Åõ„Çì')" class="px-3 py-2 rounded-xl bg-stone-50 text-stone-400 font-bold text-xs flex items-center gap-1.5 cursor-default border border-stone-100">
              <i class="fas fa-list"></i>
              Ë©≥Á¥∞
            </button>
          <% end %>

          <%# ËøΩÂä†„Éú„Çø„É≥ %>
          <button onclick="openTimeSelector('<%= date %>')" class="w-9 h-9 rounded-full bg-stone-800 text-white flex items-center justify-center shadow-md active:scale-90 transition hover:bg-stone-700">
            <i class="fas fa-plus text-sm"></i>
          </button>
        </div>

        <%# --- Èö†„ÅóË¶ÅÁ¥†: Ë©≥Á¥∞„É¢„Éº„ÉÄ„É´„ÅÆ‰∏≠Ë∫´ (JSON„Çí‰Ωø„Çè„ÅöHTML„Åß‰øùÊåÅ) --- %>
        <div id="day-content-<%= date %>" class="hidden">
           <div class="space-y-3">
             <% if has_plan %>
               <% ActualOutfit.time_slots.keys.each do |slot| %>
                 <% slot_outfits = @outfits_map[[date, slot]] %>
                 <% if slot_outfits.present? %>
                   <div class="text-xs font-bold text-stone-400 mb-1 mt-3 pl-1">
                     <%= I18n.t("enums.actual_outfit.time_slot.#{slot}") %>
                   </div>
                   <% slot_outfits.each do |outfit| %>
                     <%= link_to actual_outfit_path(outfit), class: "block bg-white border border-stone-100 rounded-xl p-3 shadow-sm hover:bg-stone-50 active:scale-[0.98] transition flex items-center justify-between mb-2" do %>
                       <div class="flex items-center gap-3">
                         <%# ÊôÇÈñì„Å®„Ç¢„Ç§„Ç≥„É≥ %>
                         <div class="flex flex-col items-center justify-center w-10">
                           <% if outfit.start_time %>
                             <span class="text-sm font-bold text-stone-700 font-feature-settings-tnum"><%= outfit.start_time.strftime("%H:%M") %></span>
                           <% else %>
                             <span class="text-xs text-stone-300">--:--</span>
                           <% end %>
                         </div>
                         
                         <%# ÂÜÖÂÆπ %>
                         <div>
                           <% if outfit.title.present? %>
                             <div class="flex items-center gap-2">
                               <span class="w-2.5 h-2.5 rounded-full inline-block" style="background-color: <%= outfit.color.presence || '#A8A29E' %>"></span>
                               <span class="font-bold text-stone-700"><%= outfit.title %></span>
                             </div>
                           <% else %>
                             <div class="flex items-center gap-2 text-stone-500">
                               <span>üëò</span>
                               <span class="text-xs font-bold">Êúç„ÅÆË®òÈå≤</span>
                             </div>
                           <% end %>
                         </div>
                       </div>
                       
                       <%# „Éê„ÉÉ„Ç∏ %>
                       <% if outfit.items.size > 0 %>
                         <div class="px-2 py-0.5 bg-indigo-50 text-indigo-600 rounded-full text-[10px] font-bold border border-indigo-100">
                           Items: <%= outfit.items.size %>
                         </div>
                       <% end %>
                       
                       <i class="fas fa-chevron-right text-stone-300 text-xs ml-2"></i>
                     <% end %>
                   <% end %>
                 <% end %>
               <% end %>
             <% else %>
               <div class="text-center py-8 text-stone-400">‰∫àÂÆö„ÅØ„ÅÇ„Çä„Åæ„Åõ„Çì</div>
             <% end %>
           </div>
        </div>

      </div>
    <% end %>
  </div>

</div>

<%# ================================================================= %>
<%#  „Äê„É¢„Éº„ÉÄ„É´: ÊôÇÈñìÂ∏ØÈÅ∏Êäû (ËøΩÂä†Áî®)„Äë                                  %>
<%# ================================================================= %>
<div id="time-selector-modal" class="fixed inset-0 z-[999] hidden" aria-labelledby="modal-title" role="dialog" aria-modal="true">
  <div class="fixed inset-0 bg-stone-900/40 backdrop-blur-sm transition-opacity opacity-0" id="modal-backdrop" onclick="closeTimeSelector()"></div>

  <div class="fixed inset-x-0 bottom-0 z-10 transform translate-y-full transition-transform duration-300 ease-out bg-[#FDFBF7] rounded-t-3xl shadow-[0_-10px_40px_rgba(0,0,0,0.1)] overflow-hidden" id="modal-panel">
    
    <div class="px-6 py-4 border-b border-stone-100 flex justify-between items-center bg-white/80 backdrop-blur-sm">
      <div>
        <h3 class="text-lg font-bold text-stone-700 font-serif" id="modal-date-display"></h3>
        <p class="text-xs text-stone-400 font-bold">„ÅÑ„Å§„ÅÆË®òÈå≤„ÇíËøΩÂä†„Åó„Åæ„Åô„ÅãÔºü</p>
      </div>
      <button type="button" onclick="closeTimeSelector()" class="bg-stone-100 text-stone-400 rounded-full w-8 h-8 flex items-center justify-center hover:bg-stone-200 transition">
        <i class="fas fa-times"></i>
      </button>
    </div>

    <div class="p-6 grid grid-cols-2 gap-4">
      <%# Êúù %>
      <a href="#" id="link-morning" class="relative group overflow-hidden rounded-2xl aspect-square bg-gradient-to-br from-[#F0F9FF] to-[#E0F2FE] border border-white shadow-sm flex flex-col items-center justify-center text-center active:scale-95 transition">
        <i class="fas fa-sun text-4xl text-sky-200 mb-2 group-hover:scale-110 transition duration-500"></i>
        <span class="font-bold text-stone-600">Êúù</span>
        <span class="text-[10px] text-stone-400">06:00 - 11:59</span>
      </a>
      <%# Êòº %>
      <a href="#" id="link-day" class="relative group overflow-hidden rounded-2xl aspect-square bg-gradient-to-br from-[#E0F2FE] to-[#BAE6FD] border border-white shadow-sm flex flex-col items-center justify-center text-center active:scale-95 transition">
        <i class="fas fa-cloud-sun text-4xl text-blue-300 mb-2 group-hover:scale-110 transition duration-500"></i>
        <span class="font-bold text-stone-600">Êòº</span>
        <span class="text-[10px] text-stone-500">12:00 - 17:59</span>
      </a>
      <%# Â§ïÊñπ %>
      <a href="#" id="link-night" class="relative group overflow-hidden rounded-2xl aspect-square bg-gradient-to-br from-[#FFF7ED] to-[#FFEDD5] border border-white shadow-sm flex flex-col items-center justify-center text-center active:scale-95 transition">
        <i class="fas fa-moon text-4xl text-orange-300 mb-2 group-hover:scale-110 transition duration-500"></i>
        <span class="font-bold text-stone-600">Â§ïÊñπ</span>
        <span class="text-[10px] text-stone-400">18:00 - 23:59</span>
      </a>
      <%# Â§ú %>
      <a href="#" id="link-late_night" class="relative group overflow-hidden rounded-2xl aspect-square bg-gradient-to-br from-[#FAFAF9] to-[#E7E5E4] border border-white shadow-sm flex flex-col items-center justify-center text-center active:scale-95 transition">
        <i class="fas fa-star text-4xl text-stone-300 mb-2 group-hover:scale-110 transition duration-500"></i>
        <span class="font-bold text-stone-600">Â§ú</span>
        <span class="text-[10px] text-stone-400">00:00 - 05:59</span>
      </a>
    </div>
  </div>
</div>


<%# ================================================================= %>
<%#  „Äê„É¢„Éº„ÉÄ„É´: „Åù„ÅÆÊó•„ÅÆ‰∫àÂÆö‰∏ÄË¶ß (Ë©≥Á¥∞Áî®)„Äë                             %>
<%# ================================================================= %>
<div id="day-detail-modal" class="fixed inset-0 z-[999] hidden" aria-labelledby="modal-title" role="dialog" aria-modal="true">
  <div class="fixed inset-0 bg-stone-900/40 backdrop-blur-sm transition-opacity opacity-0" id="detail-modal-backdrop" onclick="closeDayDetail()"></div>

  <div class="fixed inset-x-0 bottom-0 z-10 transform translate-y-full transition-transform duration-300 ease-out bg-[#FDFBF7] rounded-t-3xl shadow-[0_-10px_40px_rgba(0,0,0,0.1)] overflow-hidden max-h-[80vh] flex flex-col" id="detail-modal-panel">
    
    <div class="px-6 py-4 border-b border-stone-100 flex justify-between items-center bg-white/80 backdrop-blur-sm shrink-0">
      <div>
        <h3 class="text-lg font-bold text-stone-700 font-serif" id="detail-modal-date-display"></h3>
        <p class="text-xs text-stone-400 font-bold">‰∫àÂÆö„ÅÆ‰∏ÄË¶ß</p>
      </div>
      <button type="button" onclick="closeDayDetail()" class="bg-stone-100 text-stone-400 rounded-full w-8 h-8 flex items-center justify-center hover:bg-stone-200 transition">
        <i class="fas fa-times"></i>
      </button>
    </div>

    <div class="p-6 overflow-y-auto" id="detail-modal-body">
       <%# „Åì„Åì„Å´JS„Åß„Ç≥„É≥„ÉÜ„É≥„ÉÑ„ÇíÊ≥®ÂÖ• %>
    </div>
  </div>
</div>


<script>
  // --- ÊôÇÈñìÈÅ∏Êäû„É¢„Éº„ÉÄ„É´ (ËøΩÂä†) ---
  function openTimeSelector(dateString) {
    const modal = document.getElementById('time-selector-modal');
    const backdrop = document.getElementById('modal-backdrop');
    const panel = document.getElementById('modal-panel');
    
    const dateObj = new Date(dateString);
    const formattedDate = `${dateObj.getFullYear()}Âπ¥ ${dateObj.getMonth() + 1}Êúà ${dateObj.getDate()}Êó•`;
    document.getElementById('modal-date-display').textContent = formattedDate;

    document.getElementById('link-morning').href = `<%= new_actual_outfit_path %>?worn_on=${dateString}&time_slot=morning`;
    document.getElementById('link-day').href = `<%= new_actual_outfit_path %>?worn_on=${dateString}&time_slot=day`;
    document.getElementById('link-night').href = `<%= new_actual_outfit_path %>?worn_on=${dateString}&time_slot=night`;
    document.getElementById('link-late_night').href = `<%= new_actual_outfit_path %>?worn_on=${dateString}&time_slot=late_night`;

    modal.classList.remove('hidden');
    setTimeout(() => {
      backdrop.classList.remove('opacity-0');
      panel.classList.remove('translate-y-full');
    }, 10);
  }

  function closeTimeSelector() {
    const modal = document.getElementById('time-selector-modal');
    const backdrop = document.getElementById('modal-backdrop');
    const panel = document.getElementById('modal-panel');

    backdrop.classList.add('opacity-0');
    panel.classList.add('translate-y-full');

    setTimeout(() => {
      modal.classList.add('hidden');
    }, 300);
  }

  // --- ‰∫àÂÆö‰∏ÄË¶ß„É¢„Éº„ÉÄ„É´ (Ë©≥Á¥∞) ---
  function openDayDetail(dateString) {
    const modal = document.getElementById('day-detail-modal');
    const backdrop = document.getElementById('detail-modal-backdrop');
    const panel = document.getElementById('detail-modal-panel');
    const body = document.getElementById('detail-modal-body');

    // Êó•‰ªòË°®Á§∫
    const dateObj = new Date(dateString);
    const formattedDate = `${dateObj.getFullYear()}Âπ¥ ${dateObj.getMonth() + 1}Êúà ${dateObj.getDate()}Êó•`;
    document.getElementById('detail-modal-date-display').textContent = formattedDate;

    // „Ç≥„É≥„ÉÜ„É≥„ÉÑÊ≥®ÂÖ•
    const content = document.getElementById(`day-content-${dateString}`).innerHTML;
    body.innerHTML = content;

    modal.classList.remove('hidden');
    setTimeout(() => {
      backdrop.classList.remove('opacity-0');
      panel.classList.remove('translate-y-full');
    }, 10);
  }

  function closeDayDetail() {
    const modal = document.getElementById('day-detail-modal');
    const backdrop = document.getElementById('detail-modal-backdrop');
    const panel = document.getElementById('detail-modal-panel');

    backdrop.classList.add('opacity-0');
    panel.classList.add('translate-y-full');

    setTimeout(() => {
      modal.classList.add('hidden');
    }, 300);
  }
</script>