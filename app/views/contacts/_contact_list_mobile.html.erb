<div class="min-h-screen bg-[#F8F9FA] pb-20 md:pb-6">
  
  <%# --- ヘッダーエリア (シンプルに戻るボタンのみ) --- %>
  <div class="bg-white px-4 py-3 sticky top-0 z-30 border-b border-stone-100 md:border-none md:bg-transparent md:static md:pt-6 md:pb-4 md:px-0 max-w-6xl mx-auto">
    <div class="flex items-center justify-between relative">
      <%= link_to root_path, class: "inline-flex items-center gap-2 text-sm font-bold text-stone-500 hover:text-indigo-600 transition group md:absolute md:left-0" do %>
        <span class="w-8 h-8 rounded-full bg-stone-100 md:bg-white border border-stone-200 flex items-center justify-center group-hover:border-indigo-300 group-hover:bg-indigo-50 transition">
          <i class="fas fa-arrow-left text-xs"></i>
        </span>
        <span class="hidden md:inline">クローゼットへ戻る</span>
      <% end %>
      
      <%# スマホ用タイトル (中央寄せ) %>
      <h1 class="text-base font-bold text-stone-700 md:hidden w-full text-center pointer-events-none">
        ご縁のある人
      </h1>

      <%# 追加ボタン %>
      <%= link_to new_contact_path, class: "w-8 h-8 md:w-10 md:h-10 bg-stone-800 text-white rounded-full flex items-center justify-center shadow-sm hover:bg-stone-700 transition transform active:scale-95 md:absolute md:right-0" do %>
        <i class="fas fa-plus text-sm md:text-base"></i>
      <% end %>
    </div>
  </div>

  <div class="max-w-6xl mx-auto md:px-4">

    <%# --- 検索フォーム (フラットデザイン) --- %>
    <div class="px-4 md:px-0 mb-4 md:mb-8">
      <%= form_with url: contacts_path, method: :get, local: true, class: "relative group" do |f| %>
        <i class="fas fa-search absolute left-4 top-1/2 -translate-y-1/2 text-stone-400 group-focus-within:text-indigo-400 transition"></i>
        <%= f.text_field :query, 
            value: params[:query],
            placeholder: "名前で検索", 
            class: "w-full bg-white border border-stone-200 rounded-xl pl-11 pr-4 py-3 text-sm text-stone-700 placeholder-stone-400 focus:ring-2 focus:ring-indigo-100 focus:border-indigo-300 transition outline-none shadow-sm",
            autocomplete: "off" 
        %>
        <%= f.submit "", class: "hidden" %>
      <% end %>
    </div>

    <%# --- コンテンツエリア --- %>
    <div class="space-y-6 md:space-y-10"> 

      <%# --- セクション描画ロジック --- %>
      <% render_section = proc do |title, contacts| %>
        <div>
          <h2 class="text-sm font-bold text-stone-500 mb-2 px-4 md:px-0 flex items-baseline gap-2">
            <%= title %>
            <span class="text-xs font-normal text-stone-400">(<%= contacts.count %>)</span>
          </h2>
          
          <div class="bg-white md:bg-transparent rounded-xl overflow-hidden md:overflow-visible shadow-sm md:shadow-none border border-stone-100 md:border-none">
            <%# PC用グリッドレイアウト %>
            <div class="hidden md:grid grid-cols-3 lg:grid-cols-4 gap-4 lg:gap-5">
              <% contacts.each do |contact| %>
                <%= render partial: 'contact_card_pc', locals: { contact: contact } %>
              <% end %>
            </div>

            <%# スマホ用リストレイアウト %>
            <div class="md:hidden">
              <% contacts.each do |contact| %>
                <%= render partial: 'contact_list_mobile', locals: { contact: contact } %>
              <% end %>
            </div>
          </div>
        </div>
      <% end %>


      <%# --- データがある場合 --- %>
      <% if @contacts.any? %>
        
        <%# お気に入りを最優先表示 %>
        <% if @favorites.present? %>
          <% render_section.call("大切な人", @favorites) %>
        <% end %>

        <%# カテゴリ別表示 %>
        <% 
           grouped = @grouped_contacts || @contacts.group_by(&:category)
           order = ['family', 'friend', 'work', 'other'] 
        %>

        <% order.each do |cat_key| %>
          <% list = grouped[cat_key] || grouped[cat_key.to_sym] %>
          <% next if list.blank? %>
          
          <% title = I18n.t("enums.contact.category.#{cat_key}", default: cat_key.to_s.titleize) %>
          <% render_section.call(title, list) %>
        <% end %>

        <%# カテゴリ未設定のデータがある場合の救済措置 %>
        <% if grouped[nil].present? %>
           <% render_section.call("未分類", grouped[nil]) %>
        <% end %>

      <% else %>
        
        <%# --- データなし --- %>
        <div class="text-center py-20 px-4 mx-4 md:mx-0 bg-white rounded-3xl border border-dashed border-stone-200 mt-8">
          <div class="text-5xl mb-4 text-stone-200">
            <% if params[:query].present? %>
              <i class="fas fa-search"></i>
            <% else %>
              <i class="fas fa-user-friends"></i>
            <% end %>
          </div>
          <p class="text-stone-400 font-bold mb-6">
            <% if params[:query].present? %>
              見つかりませんでした
            <% else %>
              まだ登録されている人がいません
            <% end %>
          </p>
          
          <% unless params[:query].present? %>
            <%= link_to new_contact_path, class: "inline-flex items-center gap-2 px-6 py-3 bg-stone-800 text-white rounded-full font-bold shadow hover:bg-stone-700 transition" do %>
              <i class="fas fa-plus"></i>
              <span>最初の人を登録する</span>
            <% end %>
          <% end %>
        </div>

      <% end %>

    </div>
  </div>
</div>