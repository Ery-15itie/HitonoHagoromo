<%= form_with(model: contact, local: true, class: "space-y-6") do |form| %>
  
  <%# --- エラーメッセージ --- %>
  <% if contact.errors.any? %>
    <div class="bg-red-50 text-red-700 p-4 rounded-xl border border-red-100 mb-6">
      <ul class="list-disc list-inside text-sm">
        <% contact.errors.full_messages.each do |message| %>
          <li><%= message %></li>
        <% end %>
      </ul>
    </div>
  <% end %>

  <div class="bg-white p-6 sm:p-8 rounded-3xl shadow-sm border border-stone-100">
    
    <%# --- 1. アイコン画像  --- %>
    <div class="mb-8 flex flex-col items-center">
      
      <%# 画像表示エリア %>
      <div class="w-32 h-32 rounded-full bg-stone-100 overflow-hidden border-4 border-white shadow-md mb-4 relative">
        <%# プレビュー画像 %>
        <img id="avatar-preview" src="<%= contact.avatar.attached? ? url_for(contact.avatar.variant(resize_to_limit: [300, 300])) : '' %>" class="w-full h-full object-cover <%= contact.avatar.attached? ? '' : 'hidden' %>">
        
        <%# 画像がない時のダミーアイコン %>
        <div id="avatar-placeholder" class="w-full h-full flex items-center justify-center text-stone-300 bg-stone-50 <%= contact.avatar.attached? ? 'hidden' : '' %>">
          <i class="fas fa-user text-4xl"></i>
        </div>
      </div>

      <%# 操作ボタンエリア %>
      <div class="flex items-center gap-3">
        <%# 画像選択ボタン %>
        <label class="cursor-pointer bg-stone-100 hover:bg-stone-200 text-stone-600 font-bold py-2 px-4 rounded-full text-xs transition flex items-center gap-2 border border-stone-200">
          <i class="fas fa-camera"></i>
          <span>画像を選ぶ</span>
          <%= form.file_field :avatar, class: "hidden", accept: "image/jpeg,image/png,image/webp", id: "contact_avatar" %>
        </label>

        <%# 取消ボタン %>
        <button type="button" id="clear-avatar-button" class="hidden text-red-500 hover:bg-red-50 font-bold py-2 px-3 rounded-full text-xs transition border border-transparent hover:border-red-100 flex items-center gap-1">
          <i class="fas fa-trash-alt"></i> 削除
        </button>
      </div>
      
    </div>

    <%# --- 2. 名前 --- %>
    <div class="mb-6">
      <%= form.label :name, "お名前 (必須)", class: "block text-sm font-bold text-stone-500 mb-2" %>
      <%= form.text_field :name, class: "w-full bg-stone-50 border-stone-200 rounded-xl px-4 py-3 font-bold text-stone-700 placeholder-stone-300 focus:ring-indigo-500 focus:border-indigo-500 transition", placeholder: "例：羽衣 太郎" %>
    </div>

    <%# --- 3. カテゴリ --- %>
    <div class="mb-6">
      <%= form.label :category, "関係性グループ", class: "block text-sm font-bold text-stone-500 mb-2" %>
      <div class="relative">
        <%= form.select :category, 
            Contact.categories.keys.map { |k| [I18n.t("enums.contact.category.#{k}"), k] }, 
            {}, 
            class: "w-full bg-stone-50 border-stone-200 rounded-xl px-4 py-3 font-bold text-stone-700 focus:ring-indigo-500 focus:border-indigo-500 appearance-none cursor-pointer" %>
        <div class="pointer-events-none absolute inset-y-0 right-0 flex items-center px-4 text-stone-500">
          <i class="fas fa-chevron-down text-xs"></i>
        </div>
      </div>
    </div>

    <%# --- 4. メモ --- %>
    <div class="mb-6">
      <%= form.label :memo, "ひとことメモ (任意)", class: "block text-sm font-bold text-stone-500 mb-2" %>
      <%= form.text_area :memo, rows: 3, class: "w-full bg-stone-50 border-stone-200 rounded-xl px-4 py-3 text-stone-700 placeholder-stone-300 focus:ring-indigo-500 focus:border-indigo-500 transition", placeholder: "例：よく一緒に出かける同期" %>
    </div>

    <%# --- 5. お気に入り (★デザイン修正箇所) --- %>
    <div class="mb-2">
      <label class="group flex items-start gap-3 cursor-pointer p-4 border border-stone-200 rounded-2xl hover:bg-yellow-50/50 hover:border-yellow-200 transition select-none">
        
        <%# チェックボックスと星マークのコンテナ %>
        <div class="flex items-center gap-2 flex-shrink-0 mt-0.5">
          <%= form.check_box :is_favorite, class: "peer w-5 h-5 text-indigo-600 rounded focus:ring-indigo-500 border-gray-300 cursor-pointer" %>
          
          <%# チェック時に表示される星 (横並び・文字被りなし) %>
          <i class="fas fa-star text-yellow-400 text-xl transition-opacity opacity-0 peer-checked:opacity-100"></i>
        </div>
        
        <%# テキスト部分 %>
        <div>
          <span class="text-sm font-bold text-stone-700 block leading-tight">「大切な人」に設定する</span>
          <span class="text-xs text-stone-400">リストの一番上に大きく表示されます</span>
        </div>
      </label>
    </div>

  </div>

  <%# --- アクションボタン --- %>
  <div class="flex flex-col sm:flex-row gap-4 justify-center items-center pt-4 pb-20 sm:pb-0">
    <%= link_to "キャンセル", contacts_path, class: "w-full sm:w-auto text-center px-8 py-3 rounded-full text-stone-500 font-bold hover:bg-stone-100 transition" %>
    
    <%= form.button class: "w-full sm:w-auto px-10 py-3 rounded-full bg-indigo-600 text-white font-bold shadow-lg hover:bg-indigo-700 hover:shadow-xl transition transform hover:-translate-y-1 flex items-center justify-center gap-2" do %>
      <i class="fas fa-check"></i>
      <span>保存する</span>
    <% end %>
  </div>

<% end %>

<%# --- 画像プレビュー用スクリプト --- %>
<script>
  (function() {
    function initAvatarPreview() {
      const input = document.getElementById('contact_avatar');
      const preview = document.getElementById('avatar-preview');
      const placeholder = document.getElementById('avatar-placeholder');
      const clearBtn = document.getElementById('clear-avatar-button');

      if (!input || !preview || !placeholder || !clearBtn) return;

      // 初期状態のボタン表示制御
      if (!preview.classList.contains('hidden') && preview.getAttribute('src') !== '') {
        clearBtn.classList.remove('hidden');
      }

      // 画像選択時
      input.addEventListener('change', function(e) {
        const file = e.target.files[0];
        if (file) {
          const reader = new FileReader();
          reader.onload = function(ev) {
            preview.src = ev.target.result;
            preview.classList.remove('hidden');
            placeholder.classList.add('hidden');
            clearBtn.classList.remove('hidden');
          }
          reader.readAsDataURL(file);
        }
      });

      // 削除ボタンクリック時
      clearBtn.addEventListener('click', function() {
        input.value = '';
        preview.src = '';
        preview.classList.add('hidden');
        placeholder.classList.remove('hidden');
        clearBtn.classList.add('hidden');
      });
    }

    document.addEventListener('turbo:load', initAvatarPreview);
    document.addEventListener('DOMContentLoaded', initAvatarPreview);
  })();
</script>