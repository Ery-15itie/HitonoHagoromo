<link rel="stylesheet" href="https://cdnjs.cloudflare.com/ajax/libs/font-awesome/6.0.0/css/all.min.css">

<div class="min-h-screen bg-gray-100 md:bg-gray-50 py-6">
  
  <div class="w-full md:max-w-6xl mx-auto bg-white md:bg-transparent min-h-[80vh] md:min-h-0 shadow-xl md:shadow-none rounded-xl md:rounded-none overflow-hidden md:overflow-visible border border-gray-200 md:border-none">
    
    <div class="px-5 py-4 bg-gray-50/80 backdrop-blur-sm sticky top-0 z-30 border-b border-gray-200 flex justify-between items-center md:bg-white md:rounded-xl md:shadow-sm md:mb-6 md:border-none">
      <h1 class="text-xl font-bold text-gray-800">ご縁のある人</h1>
      <div class="flex space-x-4 text-gray-600">
        <%= link_to new_contact_path, class: "hover:text-gray-900 transition" do %>
          <i class="fas fa-user-plus text-xl"></i>
        <% end %>
        <button class="hover:text-gray-900 transition"><i class="fas fa-cog text-xl"></i></button>
      </div>
    </div>

    <div class="px-4 py-3 bg-white md:bg-transparent sticky top-[60px] md:top-0 z-20 md:static md:px-0 md:mb-8">
      <%= form_with url: contacts_path, method: :get, local: true do |f| %>
        <div class="bg-gray-100 md:bg-white text-gray-400 rounded-lg py-2 px-4 text-sm flex items-center hover:bg-gray-200 md:hover:shadow-md transition focus-within:bg-gray-50 md:focus-within:bg-white focus-within:ring-2 focus-within:ring-indigo-500/50 md:shadow-sm md:border md:border-gray-200">
          <i class="fas fa-search mr-2"></i>
          
          <%= f.text_field :query, 
              value: params[:query],
              placeholder: "名前で検索", 
              class: "bg-transparent border-none outline-none focus:ring-0 w-full text-sm text-gray-700 placeholder-gray-400 p-0",
              autocomplete: "off" 
          %>
          
          <%= f.submit "", class: "hidden" %>
        </div>
      <% end %>
    </div>

    <div class="pb-20 md:pb-0"> 
      
      <%# --- ヘルパー: アイテム描画ロジック (レスポンシブ対応) --- %>
      <% render_contact_row = proc do |contact| %>
        <div class="
          group relative transition-all duration-200 cursor-pointer bg-white
          
          /* スマホ用スタイル */
          flex items-center px-4 py-3 border-b border-gray-50 last:border-b-0 hover:bg-gray-50
          
          /* PC用スタイル */
          md:flex-col md:justify-center md:items-center md:text-center md:p-6 
          md:border md:border-gray-200 md:rounded-2xl md:shadow-sm md:hover:shadow-lg md:hover:-translate-y-1
        ">
          
          <%= link_to contact_path(contact), class: "absolute inset-0 z-0" do %>
            <span class="sr-only">詳細を見る</span>
          <% end %>

          <div class="relative z-10 mr-4 md:mr-0 md:mb-3 flex-shrink-0">
            <% if contact.avatar.attached? %>
              <%= image_tag contact.avatar, class: "w-12 h-12 md:w-24 md:h-24 rounded-full object-cover border border-gray-100 md:shadow-sm" %>
            <% else %>
              <% bg_color = case contact.group
                 when '家族' then 'bg-orange-400'
                 when '友達' then 'bg-green-400'
                 when '仕事' then 'bg-blue-400'
                 when '学校' then 'bg-pink-400'
                 else 'bg-gray-300'
                 end %>
              <div class="<%= bg_color %> w-12 h-12 md:w-24 md:h-24 rounded-full flex items-center justify-center text-white font-bold text-lg md:text-3xl md:shadow-sm">
                <%= contact.name.to_s.first&.upcase || "?" %>
              </div>
            <% end %>
          </div>

          <div class="flex-1 min-w-0 z-10 pointer-events-none md:w-full"> 
            <div class="flex justify-between items-baseline md:justify-center">
              <h2 class="text-base md:text-lg font-semibold text-gray-900 truncate">
                <%= contact.name %>
              </h2>
            </div>
            <p class="text-xs md:text-sm text-gray-500 truncate mt-0.5 md:mt-2 md:whitespace-normal md:line-clamp-2 md:h-10">
              <%= contact.memo.presence || "ステータスメッセージなし" %>
            </p>
          </div>

          <div class="relative z-20 ml-2 md:absolute md:top-3 md:right-3 md:ml-0">
            <%= button_to toggle_favorite_contact_path(contact), method: :patch, class: "p-2 focus:outline-none transition transform active:scale-90 md:bg-white/80 md:rounded-full md:hover:bg-white" do %>
              <% if contact.is_favorite? %>
                <i class="fas fa-star text-yellow-400 text-lg md:text-xl"></i>
              <% else %>
                <i class="far fa-star text-gray-300 text-lg md:text-xl hover:text-gray-400"></i>
              <% end %>
            <% end %>
          </div>
        </div>
      <% end %>


      <%# --- 共通セクションラッパー --- %>
      <%# PCの場合はグリッドレイアウトにするためのラッパー %>
      <% render_section_wrapper = proc do |title, contacts| %>
        <div class="md:mb-10">
          <div class="px-4 py-1 bg-gray-50 md:bg-transparent border-t border-b border-gray-100 md:border-none text-xs md:text-lg md:text-gray-700 text-gray-500 font-bold mt-2 md:mt-0 md:mb-4">
            <%= title %> (<%= contacts.count %>)
          </div>
          
          <div class="block md:grid md:grid-cols-3 lg:grid-cols-4 md:gap-5">
            <% contacts.each do |contact| %>
              <% render_contact_row.call(contact) %>
            <% end %>
          </div>
        </div>
      <% end %>


      <%# --- お気に入りセクション --- %>
      <% if @favorites.present? %>
        <% render_section_wrapper.call("大切な人", @favorites) %>
      <% end %>


      <%# --- グループ別セクション --- %>
      <% @groups_order.each do |group_key| %>
        <% contacts = @grouped_contacts[group_key] %>
        <% next if contacts.blank? %>

        <% title = t("enums.contact.group.#{group_key}", default: group_key.titleize) %>
        <% render_section_wrapper.call(title, contacts) %>
      <% end %>

      <%# --- データが一件もない場合 --- %>
      <% if @favorites.blank? && @grouped_contacts.blank? %>
        <div class="text-center py-10 px-6">
          <div class="text-gray-300 text-6xl mb-4">
            <% if params[:query].present? %>
              <i class="fas fa-search-minus"></i>
            <% else %>
              <i class="fas fa-user-friends"></i>
            <% end %>
          </div>
          <p class="text-gray-500 mb-4">
            <% if params[:query].present? %>
              見つかりませんでした。<br>別のキーワードで試してください。
            <% else %>
              まだご縁のある人がいません。<br>右上のアイコンから追加しましょう！
            <% end %>
          </p>
          <% unless params[:query].present? %>
            <%= link_to "新しく人を登録", new_contact_path, class: "inline-block bg-green-500 hover:bg-green-600 text-white font-bold py-2 px-6 rounded-full shadow transition" %>
          <% end %>
        </div>
      <% end %>

    </div>
  </div>
</div>